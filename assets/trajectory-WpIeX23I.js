var O=f=>{throw TypeError(f)};var N=(f,g,e)=>g.has(f)||O("Cannot "+e);var p=(f,g,e)=>(N(f,g,"read from private field"),e?e.call(f):g.get(f)),y=(f,g,e)=>g.has(f)?O("Cannot add the same private member more than once"):g instanceof WeakSet?g.add(f):g.set(f,e),u=(f,g,e,a)=>(N(f,g,"write to private field"),a?a.call(f,e):g.set(f,e),e),k=(f,g,e)=>(N(f,g,"access private method"),e);var $,j,w,b,S,v,m,E,T,D;const x=class x extends ui.view.DefaultTheme.TrajectoryUI{constructor(){super();y(this,T);y(this,$);y(this,j);y(this,w);y(this,b);y(this,S);y(this,v);y(this,m,null);let e=[0,0];this.panelTrajectory.on(Laya.Event.MOUSE_DOWN,this,a=>e=[a.stageX,a.stageY]),this.panelTrajectory.on(Laya.Event.MOUSE_UP,this,a=>{const h=a.stageX-e[0],t=a.stageY-e[1];Math.sqrt(Math.abs(h)+Math.abs(t))>10||this.onNext()}),this.btnSummary.on(Laya.Event.CLICK,this,this.onSummary),this.panelTrajectory.vScrollBar.elasticDistance=150,this.boxSpeed.visible=!1,this.scbSpeed.visible=!1,this.scbSpeed.mouseEnabled=!1,this.prgSpeed.visible=!1,u(this,m,null)}static load(){return["images/atlas/images/progress.atlas","images/atlas/images/slider.atlas"]}checkEventData(){if(console.log("🔍 === 检查原始事件数据 ==="),window.core&&core.events&&console.log("核心事件数据:",core.events),window.core&&core.getEvent){const e=core.getEvent(20037);console.log("事件20037原始数据:",e)}window.gameData&&console.log("游戏数据:",gameData),console.log("🔍 === 检查结束 ===")}init({propertyAllocate:e,talents:a,enableExtend:h}){u(this,v,h),this.boxParticle.visible=!1,this.btnSummary.visible=!1,u(this,b,[]),u(this,w,!1),u(this,S,a),u(this,m,null),core.start(e),this.updateProperty(),this.onNext()}close(){p(this,b).forEach(e=>{e.removeSelf(),e.destroy()}),u(this,b,null),u(this,m,null)}updateProperty(){const e=core.PropertyTypes,a=core.propertys;this.labCharm.text=a[e.CHR],this.labIntelligence.text=a[e.INT],this.labStrength.text=a[e.STR],this.labMoney.text=a[e.MNY],this.labSpirit.text=a[e.SPR]}onNext(){if(!p(this,m)&&!p(this,w))try{const e=core.next();if(!e){console.error("❌ core.next() 返回 undefined"),u(this,w,!0),this.boxSpeed.visible=!1,this.btnSummary.visible=!0;return}const{age:a,content:h,isEnd:t}=e;u(this,w,t),t&&(this.boxSpeed.visible=!1,this.btnSummary.visible=!0,Laya.timer.frameOnce(1,this,()=>{this.panelTrajectory.scrollTo(0,this.panelTrajectory.contentHeight)})),this.panelTrajectory.scrollTo(0,this.panelTrajectory.contentHeight),this.renderTrajectory(a,h),a>=48&&(this.boxSpeed.visible=!1,this.boxParticle.visible=!0),this.updateProperty()}catch(e){console.error("❌ onNext 执行出错:",e),u(this,w,!0),this.boxSpeed.visible=!1,this.btnSummary.visible=!0}}renderTrajectory(e,a){const h=k(this,T,D).call(this);h.labAge.text=""+e;const t=a.find(s=>s.isChoice);if(t){console.log("=== 选择事件完整数据 ==="),console.log("choiceEvent:",JSON.stringify(t,null,2));const s=["image","img","picture","pic","icon","avatar","photo","illustration","eventImage"];let o=null,r=null;s.forEach(n=>{t[n]&&typeof t[n]=="string"&&(o=n,r=t[n],console.log(`✅ 找到图片字段 "${n}":`,t[n].substring(0,100)+"..."))}),o&&o!=="image"&&(console.log(`🔄 将字段 "${o}" 复制到 "image" 字段`),t.image=r),u(this,m,t),h.labContent.text=a.map(({type:n,description:i,grade:c,name:l,postEvent:d})=>{switch(n){case"TLT":return`天赋【${l}】发动：${i}`;case"EVT":return i}}).join(`
`),Laya.timer.frameOnce(5,this,()=>{this.showChoicePopup(t)})}else h.labContent.text=a.map(({type:s,description:o,grade:r,name:n,postEvent:i})=>{switch(s){case"TLT":return`天赋【${n}】发动：${o}`;case"EVT":return o+(i?`
${i}`:"")}}).join(`
`);h.grade(a[a.length-1].grade),this.vboxTrajectory.addChild(h),p(this,b).push(h),h.y=this.vboxTrajectory.height,Laya.timer.frameOnce(1,this,()=>{this.panelTrajectory.scrollTo(0,this.panelTrajectory.contentHeight)})}showChoicePopup(e){console.log("显示选择弹窗，选项数量:",e.choices.length);const a=new Laya.Box;a.name="choicePopup",a.width=Laya.stage.width,a.height=Laya.stage.height,a.x=0,a.y=0;const h=new Laya.Box;h.width=Laya.stage.width,h.height=Laya.stage.height,h.alpha=.7,h.graphics.drawRect(0,0,h.width,h.height,"#000000"),a.addChild(h),this.addChild(a);const t=new Laya.Box;t.name="mainPopup",t.width=1e3,t.height=720,t.x=(Laya.stage.width-t.width)/2,t.y=(Laya.stage.height-t.height)/2;const s=new Laya.runtime.ColorfulBox;if(s.width=t.width,s.height=t.height,s.defaultColor="#1a1a1a",s.hoverColor="#333333",s.defaultStroke="#ffffff",s.lineWidth=2,s.radius=5,s.mouseEnabled=!0,t.addChild(s),a.addChild(t),e.image){console.log("加载事件图片:",e.image);try{const i=new Laya.Image,c=`images/events/${e.image}`;console.log("图片完整路径:",c),i.skin=c,i.width=450,i.height=450,i.x=t.x+20,i.y=t.y-i.height-20,i.on(Laya.Event.LOADED,this,()=>{console.log("✅ 事件图片加载成功！")}),i.on(Laya.Event.ERROR,this,l=>{console.log("❌ 事件图片加载失败:",l)}),a.addChild(i)}catch(i){console.error("❌ 图片创建异常:",i)}}const o=new Laya.Label;o.text="政务决策",o.width=t.width,o.height=96,o.y=30,o.fontSize=64,o.color="#ffffff",o.font="SimHei",o.align="center",o.valign="middle",o.bold=!0,t.addChild(o);const r=new Laya.Label;r.text=e.description,r.width=t.width-120,r.height=220,r.x=60,r.y=120,r.fontSize=56,r.color="#e1e1e1",r.font="SimHei",r.align="center",r.valign="middle",r.wordWrap=!0,r.leading=10,t.addChild(r);const n=new Laya.Box;n.name="optionsBox",n.width=t.width-120,n.height=360,n.x=60,n.y=360,n.mouseEnabled=!0,n.mouseThrough=!1,t.addChild(n),e.choices.forEach((i,c)=>{const l=new Laya.runtime.ColorfulBox;l.name=`choiceBtn${c}`,l.width=n.width-80,l.height=100,l.x=40,l.y=c*120,l.mouseEnabled=!0,l.defaultColor="#2a2a2a",l.hoverColor="#3a3a3a",l.defaultStroke="#ffffff",l.hoverStroke="#ffffff",l.lineWidth=1,l.radius=5;const d=new Laya.Label;d.name="label",d.text=`${String.fromCharCode(65+c)}. ${i.text}`,d.width=l.width,d.height=l.height,d.fontSize=52,d.color="#ffffff",d.font="SimHei",d.align="center",d.valign="middle",l.addChild(d),l.defaultLabel="#ffffff",l.hoverLabel="#ffffff",l.on(Laya.Event.CLICK,this,()=>{this.onChoiceSelected(e.eventId,c,a,e)}),n.addChild(l)}),t.on(Laya.Event.MOUSE_DOWN,this,i=>{i.stopPropagation()}),t.on(Laya.Event.MOUSE_UP,this,i=>{i.stopPropagation()})}onChoiceSelected(e,a,h,t){console.log(`玩家选择了选项 ${a}`),h&&(h.removeSelf(),h.destroy()),core.processChoice(e,a);const s=t.choices[a];if(console.log("🔍 选择的选项数据:",{hasResult:!!s.result,hasEffect:!!s.effect,effectString:s.effect,allChoiceFields:Object.keys(s)}),s&&s.result){const o=s.effect;console.log("🔍 effect字符串:",o),this.showChoiceResult(s.result,o)}else u(this,m,null),Laya.timer.frameOnce(30,this,()=>{this.onNext()})}showChoiceResult(e,a){console.log("显示选择结果:",e),console.log("🔍 原始effect字符串:",a);let h="";if(a&&a.trim()!==""){const L=a.split(",");console.log("🔍 分割后的effects:",L);const R=[],U={CHR:"民意",INT:"环境",STR:"人口",MNY:"财政",SPR:"稳定度"};L.forEach(C=>{if(C&&C.trim()!==""){console.log("🔍 处理单个effect:",C);const P=C.match(/(CHR|INT|STR|MNY|SPR)([-+]?\d+)/);if(P){const I=P[1],B=P[2],M=U[I];R.push(`${M}${B}`),console.log(`🔍 解析成功: ${I}${B} -> ${M}${B}`)}else console.log("🔍 解析失败，effect格式:",C)}}),h=R.join("，"),console.log("🔍 最终effect描述:",h)}else console.log("🔍 effect字符串为空或无效");const t=new Laya.Box;t.name="choiceResultPopup",t.width=Laya.stage.width,t.height=Laya.stage.height,t.x=0,t.y=0;const s=new Laya.Box;s.width=Laya.stage.width,s.height=Laya.stage.height,s.alpha=.7,s.graphics.drawRect(0,0,s.width,s.height,"#000000"),t.addChild(s),this.addChild(t);const o=new Laya.Box;o.name="resultPopup",o.width=1e3,o.height=720,o.x=(Laya.stage.width-o.width)/2,o.y=(Laya.stage.height-o.height)/2;const r=new Laya.runtime.ColorfulBox;r.width=o.width,r.height=o.height,r.defaultColor="#1a1a1a",r.hoverColor="#333333",r.defaultStroke="#ffffff",r.lineWidth=2,r.radius=5,r.mouseEnabled=!0,o.addChild(r),t.addChild(o);const n=new Laya.Label;n.text="结果",n.width=o.width,n.height=96,n.y=30,n.fontSize=84,n.color="#ffffff",n.font="SimHei",n.align="center",n.valign="middle",n.bold=!0,o.addChild(n);const i=new Laya.Label;i.text=e,i.width=o.width-120,i.height=400,i.x=60,i.y=140,i.fontSize=56,i.color="#e1e1e1",i.font="SimHei",i.align="center",i.valign="middle",i.wordWrap=!0,i.leading=10,o.addChild(i);const c=new Laya.Label;c.text=h||"无属性变化",c.width=o.width,c.height=50,c.y=500,c.fontSize=38,c.color="#aaaaaa",c.font="SimHei",c.align="center",c.valign="middle",c.bold=!0,o.addChild(c);const l=new Laya.runtime.ColorfulBox;l.name="confirmBtn",l.width=200,l.height=80,l.x=(o.width-200)/2,l.y=600,l.mouseEnabled=!0,l.defaultColor="#2a2a2a",l.hoverColor="#3a3a3a",l.defaultStroke="#ffffff",l.hoverStroke="#ffffff",l.lineWidth=1,l.radius=5;const d=new Laya.Label;d.text="确定",d.width=200,d.height=80,d.fontSize=42,d.color="#ffffff",d.font="SimHei",d.align="center",d.valign="middle",l.addChild(d),l.on(Laya.Event.CLICK,this,()=>{t.removeSelf(),t.destroy(),u(this,m,null),Laya.timer.frameOnce(30,this,()=>{this.onNext()})}),o.addChild(l),o.on(Laya.Event.MOUSE_DOWN,this,L=>{L.stopPropagation()}),o.on(Laya.Event.MOUSE_UP,this,L=>{L.stopPropagation()})}createImagePlaceholder(e,a,h,t="无数据"){const s=new Laya.Box;s.name="imagePlaceholder",s.width=200,s.height=200,s.x=a,s.y=h;const o=new Laya.Sprite;o.graphics.drawRect(0,0,200,200,"#444444"),s.addChild(o);const r=new Laya.Sprite;r.graphics.drawRect(0,0,200,200,null,"#ff0000",2),s.addChild(r);const n=new Laya.Label;n.text=t,n.color="#ffffff",n.fontSize=40,n.width=200,n.height=40,n.y=70,n.align="center",n.valign="middle",n.bold=!0,s.addChild(n);const i=new Laya.Label;return i.text="图片加载失败",i.color="#cccccc",i.fontSize=36,i.width=200,i.height=30,i.y=110,i.align="center",i.valign="middle",s.addChild(i),e.addChild(s),s}onSummary(){const e=p(this,S);$ui.switchView(UI.pages.SUMMARY,{talents:e,enableExtend:p(this,v)})}};$=new WeakMap,j=new WeakMap,w=new WeakMap,b=new WeakMap,S=new WeakMap,v=new WeakMap,m=new WeakMap,E=new WeakMap,T=new WeakSet,D=function(){var h;const e=p(h=x,E).call(h,"boxTrajectoryItem");e.labContent=e.getChildByName("labContent"),e.labAge=e.getChildByName("hboxAge").getChildByName("labAge");const a=$ui.common.trajectoryItem;return $_.deepMapSet(e,a.box),e.grade=t=>{$_.deepMapSet(e,a.grade[t||0])},e.getChildByName("hboxAge")._childs.forEach(t=>t.color=a.ageColor),e.labContent.color=a.contentColor,e},y(x,E,Laya.plugin.extractComponents(x.uiView,["boxTrajectoryItem"]));let H=x;export{H as default};
